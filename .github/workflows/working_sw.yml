name: ML Pipeline CI

on: [push, pull_request]

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Cache model artifacts
        uses: actions/cache@v3
        with:
          path: |
            src/model/model-config
            ~/.cache/torch
          key: ${{ runner.os }}-model-${{ hashFiles('src/model/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-model-

      # Code quality checks
      - name: Check code formatting (Black)
        run: |
          echo "Checking code format with Black..."
          black --check src tests

      - name: Run linter (Flake8)
        run: |
          echo "Running flake8 linter..."
          flake8 src/ tests/

      # Data preprocessing pipeline
      - name: Run PDF extraction script
        run: |
          mkdir -p data/processed-text
          mkdir -p data/useful
          mkdir -p data/not-useful
          mkdir -p data/needs-check
          INPUT_PDF="tests/test.pdf"
          python src/preprocessing/pdf_text_extraction.py "$INPUT_PDF"

      - name: Generate labels
        run: |
          echo "Generating labels for extracted text..."
          python src/preprocessing/generate_labels.py
          
      - name: Load and preprocess data
        run: |
          echo "Loading and preprocessing dataset..."
          python src/preprocessing/data_loader.py

      - name: Validate preprocessing pipeline
        run: |
          # Validate PDF extraction
          INPUT_PDF="tests/test.pdf"
          OUTPUT_FILE="data/processed-text/$(basename "$INPUT_PDF" .pdf).txt"
          
          echo "Validating PDF extraction..."
          [ -f "$OUTPUT_FILE" ] && [ -s "$OUTPUT_FILE" ] || exit 1
          
          # Validate labels
          echo "Validating label generation..."
          [ -f "data/labels.json" ] || exit 1
          
          # Validate data loading
          echo "Validating data loading..."
          python -c "import json; f=open('data/labels.json'); json.load(f); f.close()" || exit 1

      # Model training and evaluation pipeline
      - name: Train model
        run: |
          echo "Training PDF classifier model..."
          python src/model/train_model.py
          
      - name: Test model classification
        run: |
          echo "Testing PDF classifier..."
          python src/model/pdf_classifier.py --test-mode

      # Unit testing and coverage
      - name: Run unit tests with coverage
        run: |
          echo "Running pytest with coverage..."
          coverage run -m pytest tests/
          coverage report -m
          coverage html

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: src/model/model-config/

      - name: Show pipeline summary
        run: |
          echo "Pipeline Summary:"
          echo "1. PDF Extraction Results:"
          ls -l data/processed-text/
          echo "2. Label Generation Results:"
          ls -l data/labels.json
          echo "3. Model Training Results:"
          ls -l src/model/model-config/
          echo "4. Classification Results:"
          python src/model/pdf_classifier.py --status
