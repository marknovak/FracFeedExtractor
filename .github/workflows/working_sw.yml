name: PDF Extraction CI

on: [push, pull_request]

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Code quality checks
      - name: Check code formatting (Black)
        run: |
          echo "Checking code format with Black..."
          black --check src tests

      - name: Run linter (Flake8)
        run: |
          echo "Running flake8 linter..."
          flake8 src/ tests/ --statistics --count || true
          echo "Flake8 check completed."

      # Functional validation
      - name: Run PDF extraction script
        run: |
          mkdir -p data/processed-text
          INPUT_PDF="tests/test.pdf"
          python src/preprocessing/pdf_text_extraction.py "$INPUT_PDF"

      - name: Validate extraction output
        run: |
          INPUT_PDF="tests/test.pdf"
          OUTPUT_FILE="data/processed-text/$(basename "$INPUT_PDF" .pdf).txt"
          total_tests=5
          failures=0

          # Test 1: Output file exists
          [ -f "$OUTPUT_FILE" ] && echo "Test 1 passed: file exists" || { echo "Test 1 failed: missing"; failures=$((failures+1)); }

          # Test 2: File is not empty
          [ -s "$OUTPUT_FILE" ] && echo "Test 2 passed: not empty" || { echo "Test 2 failed: empty"; failures=$((failures+1)); }

          # Test 3: At least one line
          line_count=$(wc -l < "$OUTPUT_FILE")
          [ "$line_count" -ge 1 ] && echo "Test 3 passed: $line_count lines" || { echo "Test 3 failed: no lines"; failures=$((failures+1)); }

          # Test 4: At least one word
          word_count=$(wc -w < "$OUTPUT_FILE")
          [ "$word_count" -ge 1 ] && echo "Test 4 passed: $word_count words" || { echo "Test 4 failed: no words"; failures=$((failures+1)); }

          # Test 5: Reasonable file size
          file_size=$(stat -c%s "$OUTPUT_FILE")
          [ "$file_size" -ge 10 ] && echo "Test 5 passed: size ${file_size} bytes" || { echo "Test 5 failed: too small (${file_size})"; failures=$((failures+1)); }

          echo "Summary: $total_tests tests, $failures failed"
          [ $failures -eq 0 ]

      # Unit testing and coverage
      - name: Run unit tests with coverage
        run: |
          echo "Running pytest with coverage..."
          coverage run -m pytest tests/
          coverage report -m
          coverage html

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Show extracted text
        run: |
          INPUT_PDF="tests/test.pdf"
          OUTPUT_FILE="data/processed-text/$(basename "$INPUT_PDF" .pdf).txt"
          echo " Extracted text from $OUTPUT_FILE:"
          cat "$OUTPUT_FILE" || echo " No output file found"
